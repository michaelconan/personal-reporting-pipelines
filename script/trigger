#!/bin/bash

# script/trigger: Trigger airflow DAGs using common schedules.

# Get the current weekday (0=Sunday)
weekday=$(date +%u)

# Get all airflow dags
all_dags=$(airflow dags list -o json)

# Loop through all DAGs and trigger those with specific schedules
recurring_ran=0
dataset_dags=()
for dag_id in $(echo "$all_dags" | jq -r '.[].dag_id'); do
  # Get the schedule for the DAG
  dag_info=$(airflow dags details "$dag_id" -o json)
  schedule=$(echo "$dag_info" | jq -r '.schedule_interval.value')
  # Trigger DAGs based on their schedule
  if [[ "$schedule" == "@daily" || ("$schedule" == "@weekly" && $weekday -eq 0) ]]; then
    echo "Triggering DAG: $dag_id"
    airflow dags test "$dag_id"
    recurring_ran=1
  # Store Dataset DAGs to trigger later
  elif [[ "$schedule" == "Dataset" ]]; then
    dataset_dags+=("$dag_id")
    echo "Queued Dataset DAG: $dag_id"
  else
    echo "Skipping DAG: $dag_id (schedule: $schedule)"
  fi

done

# After the loop, if any recurring DAGs ran, trigger all Dataset DAGs
if [[ $recurring_ran -eq 1 && ${#dataset_dags[@]} -gt 0 ]]; then
  echo "Triggering Dataset DAGs: ${dataset_dags[*]}"
  for dataset_dag in "${dataset_dags[@]}"; do
    airflow dags test "$dataset_dag"
  done
fi